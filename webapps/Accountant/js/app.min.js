"use strict";function uploadUpdate(e,t){var n=new FormData;n.append("file",e.files[0]),n.append("fsid",t);var a=(new Date).getTime();return $.ajax({url:"UploadFile?time="+a,type:"POST",cache:!1,contentType:!1,processData:!1,data:n,dataType:"json",xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",onProgress,!1),e},success:function(e){var n=e.files[0];return renderFilePanel(n,t),e},error:function(e){console.log(e)},complete:function(){$("progress").attr({value:0,max:100}),e.form.reset(),insertParam("fsid",t)}})}function onProgress(e){e.lengthComputable&&$("progress").attr({value:e.loaded,max:e.total})}function loadFile(e,t,n){nb.uiBlock();var a=nb.notify({type:"info",message:"Идет загрузка данных. Пожалуйста подождите..."}).show();return $.ajax({type:"post",dataType:"json",url:"Provider?type=page&id=load-file-data&fileid="+e+"&fsid="+n,data:t,success:function(e){return e},error:function(e){return nb.notify({type:"error",message:"Ошибка загрузки"}).show(2e3),e},complete:function(){nb.uiUnblock(),a.remove()}})}function delFile(e,t){return $.ajax({type:"delete",dataType:"json",url:"Provider?type=page&id=delete-attach&fileid="+e+"&fsid="+t})}function checkFile(e,t){nb.uiBlock();var n=nb.notify({type:"info",message:"Идет проверка структуры файла. Пожалуйста подождите..."}).show();return $.ajax({type:"get",dataType:"html",url:"Provider?type=page&id=check-file-structure&fileid="+e+"&fsid="+t,success:function(e){return e},error:function(){return!1},complete:function(){nb.uiUnblock(),n.remove(200)}})}function renderFilePanel(e,t){var n,a,o=$('form[name=js-init-update-panel][data-file-name="'+e+'"]'),i=o.length;i?a=o:(n=$("#tpl_update_file_panel").clone(),a=$(n.html().trim())),a.attr("name","form"+(new Date).getTime());var r=a.find(".js-link").attr("href");a.find(".js-link").attr("href",r+e).html(e),a.find(".js-check").on("click",function(n){n.stopPropagation(),n.preventDefault();var a=$(this);a.attr("disabled",!0),checkFile(e,t).then(function(e){location.reload()},function(e){location.reload()})}),a.find(".js-delete").on("click",function(n){n.stopPropagation(),n.preventDefault(),delFile(e,t).then(function(){a.remove()})}),a.find(".js-load").on("click",function(n){n.stopPropagation(),n.preventDefault(),$(this).attr("disabled",!0),loadFile(e,a.serialize(),t).then(function(){location.reload()},function(){location.reload()})}),a.find(".js-select-balance-holder").on("click",function(e){e.stopPropagation(),e.preventDefault(),$(this).parents(".panel").addClass("open"),nbApp.choiceBalanceHolder(this,function(){toggleLoadButtonState(a)}),a.find(".errormsg").remove()}),a.find(".js-select-readers").on("click",function(e){e.stopPropagation(),e.preventDefault(),$(this).parents(".panel").addClass("open"),nbApp.choiceReaders(this,function(){toggleLoadButtonState(a)}),a.find(".errormsg").remove()}),i||$(".js-uploaded-files").append(a)}function toggleLoadButtonState(e){var t=e.find("[name=balanceholder]").val(),n=e.find("[name=reader]").val();t&&n&&e.find(".js-load").attr("disabled",!1)}function insertParam(e,t){for(var n,a=encodeURI(e),o=encodeURI(t),i=document.location.search.substr(1).split("&"),r=i.length;r--;)if(n=i[r].split("="),n[0]==a){n[1]=o,i[r]=n.join("=");break}0>r&&(i[i.length]=[a,o].join("=")),history.replaceState(null,null,location.pathname+"?"+i.join("&"))}function initCachedUpdateForm(){if(-1!==location.search.indexOf("fsid")){var e=location.search.split("fsid=")[1];$("form[name=js-init-update-panel][data-file-name]").each(function(){renderFilePanel($(this).data("file-name"),e)})}}var nb={APP_NAME:location.hostname,LANG_ID:"RUS",debug:!1,translations:{yes:"Да",no:"Нет",ok:"Ok",cancel:"Отмена",select:"Выбрать",dialog_select_value:"Вы не сделали выбор"},tpl:{}},nbApp={};nb.ajax=function(e){return $.ajax(e)},nb.getText=function(e,t){return this.translations[e]?this.translations[e]:void 0!==t?t:e},nb.getForm=function(e){if(null===e||void 0===e)return e;if("string"==typeof e&&document[e]&&"FORM"===document[e].nodeName)return document[e];var t=$(e).parents("form");return t.length&&(e=t.get(0)),e.form||e},nb.uiBlock=function(){var e=$("#nb-block-ui");0===e.length&&(e=$('<div id="nb-block-ui" style="background:rgba(0,0,0,0.1);cursor:wait;position:fixed;top:0;left:0;bottom:0;right:0;z-index:999;"/>'),e.appendTo("body")),e.css("display","block")},nb.uiUnblock=function(){$("#nb-block-ui").css("display","none")},nb.template=function(e,t){if(nb.tpl[e])return nb.tpl[e].call(this,t);throw new Error("nb.error > Template not found: "+e+", data: "+t)},$(document).ready(function(){nb.LANG_ID=$.cookie("lang")||"RUS";var e=localStorage.getItem("side-tree-toggle"),t=[];null!=e?t=e.split(","):localStorage.setItem("side-tree-toggle",""),$("[data-nav]",".aside").each(function(){-1!=t.indexOf($(this).data("nav"))&&$(this).removeClass("nav-link-collapsed")}),$(":checkbox").bind("click",function(){var e=$(this);if(!e.data("toggle"))return!0;var t=this.name||e.data("toggle"),n=$("[name="+t+"]:checkbox:visible");e.is(":checked")?n.each(function(){this.checked=!0}):n.each(function(){this.checked=!1})}),$("[data-role=side-tree-toggle]").click(function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();t.toggleClass("nav-link-collapsed");var n="side-tree-toggle",a=t.data("nav"),o=localStorage.getItem(n),i=o.split(",");if(t.hasClass("nav-link-collapsed")){var r=i.indexOf(a);r>-1&&i.splice(r,1),localStorage.setItem(n,i.join(","))}else i.push(a),localStorage.setItem(n,i.join(","))}),$(document).on("click","[data-toggle=panel]",function(){var e=$(this).parents(".panel");e.toggleClass("open")}),$(document).on("click","[data-toggle=side-nav]",function(e){e.preventDefault(),$("body").toggleClass("side-nav-toggle")}),$("#content-overlay").length&&($("#content-overlay").mousedown(function(e){e.preventDefault(),$("body").removeClass("side-nav-toggle  search-open"),$(".navbar-search input.q").length&&$(".navbar-search input.q")[0].blur()}),$("#content-overlay")[0].addEventListener("touchstart",function(e){e.preventDefault(),$("body").removeClass("side-nav-toggle")},!1)),$(".navbar-search input.q").on("focus",function(){$("body").addClass("search-open")}),$(".navbar-search input.q").on("blur",function(){$("body").removeClass("search-open")}),$(window).resize(function(){window.innerWidth<=800?$("body").addClass("phone"):$("body").removeClass("phone")}),window.innerWidth<=800&&$("body").addClass("phone"),setTimeout(function(){$("body").removeClass("no_transition")},250)}),nb.dialog={_props:{title:nb.APP_NAME},info:function(e){return e.className="dialog-info",e.width=e.width||360,e.height=e.height||210,e.buttons=e.buttons||{Ok:function(){$(this).dialog("close")}},this.show(e)},warn:function(e){return e.className="dialog-warn",e.width=e.width||360,e.height=e.height||210,e.buttons=e.buttons||{Ok:function(){$(this).dialog("close")}},this.show(e)},error:function(e){return e.className="dialog-error",e.width=e.width||360,e.height=e.height||210,e.buttons=e.buttons||{Ok:function(){$(this).dialog("close")}},this.show(e)},execute:function(e){var t=$(e).parents("[role=dialog]"),n=$("[data-role=nb-dialog]",t);n[0].dialogOptions.onExecute(arguments)},resize:function(e){var t=$(e[0]).parents("[role=dialog]");if("none"!==t.css("display")){for(var n,a,o=$(".ui-dialog-titlebar",t[0]).outerHeight(),i=$(".ui-dialog-buttonpane",t[0]).outerHeight(),r=$(".dialog-filter",t[0]).outerHeight(),l=o+i+r,s=window.innerHeight,d=$(".nb-dialog-container",t[0]).get(0),c=d.offsetTop,u=0;u<d.children.length;u++)c+=d.children[u].clientHeight+d.children[u].offsetTop;600>s&&c>300?(n=window.scrollY+1,a=s-3):(a=s>800&&c>600?s/1.2:c+l,n=(s-a)/2,0>n?(n=window.scrollY+1,a=s-3):n+=window.scrollY);var f=(window.innerWidth-t.outerWidth())/2;t.css({height:a+"px",top:n+"px",left:f+"px"}),$(d).css({height:t[0].clientHeight-l+"px",maxHeight:"none"})}},load:function(e,t,n){return $.ajax({url:e,dataType:n.dataType||"html",success:function(e,a,o){"error"===a?t.html('<div class="alert alert-danger">'+a+"</div>"):("json"===n.dataType?t.html(nb.template.call(n,n.templateId,e)):t.html(e),null!==n.onLoad&&n.onLoad(e,a,o),n.filter!==!1&&new nb.dialog.Filter(t,n.dialogFilterListItem,13));try{window.dispatchEvent(new Event("resize"))}catch(i){}nb.debug===!0&&console.log("nb.dialog : load callback",o)},error:function(e,n,a){"error"===n&&t.html('<div class="alert alert-danger">'+n+"</div>");try{window.dispatchEvent(new Event("resize"))}catch(o){}nb.debug===!0&&console.log("nb.dialog : load error",a)}})},show:function(e){var t,n=this;if(e.id=e.id||null,e.title=e.title||this._props.title,e.href=e.href||null,e.className=e.className||"",e.message=e.message||null,e.filter=e.filter,e.dialogFilterListItem=e.dialogFilterListItem||"li",e.buttons=e.buttons||null,e.dialogClass="nb-dialog "+(e.dialogClass?e.dialogClass:""),e.errorMessage=e.errorMessage||nb.getText("dialog_select_value"),e.templateId=e.templateId||"defaultDialogListTemplate",e.onLoad=e.onLoad||null,e.onExecute=e.onExecute||function(){nb.setFormValues(t)&&t.dialog("close")},e.autoOpen=!0,e.modal===!1?e.modal=!1:e.modal=!0,e.width=e.width||500,e.position={top:window.scrollY},e.resizable=!1,e.draggable=!1,!e.id&&e.href){if(e.id="dlg_"+e.href.replace(/[^a-z0-9]/gi,""),t=$("#"+e.id),t[0])return t.dialog("isOpen")===!0?void 0:(t.dialog("open"),void n.resize(t))}else if(e.id&&(t=$("#"+e.id),t[0]))return t.dialog("isOpen")===!0?void 0:(t.dialog("open"),void n.resize(t));var a;a=e.href?$('<div data-role="nb-dialog" id="'+e.id+'" class="nb-dialog-container '+e.className+'"><div class="loading-state"></div></div>'):e.id?$('<div data-role="nb-dialog" id="'+e.id+'" class="nb-dialog-container '+e.className+'">'+e.message+"</div>"):$('<div data-role="nb-dialog" class="nb-dialog-container '+e.className+'">'+e.message+"</div>"),a[0].dialogOptions=e,e.href?(n.load(e.href,a,e),t=a.dialog(e),a.on("click","a",function(t){t.preventDefault(),n.load(this.href,a,e)})):t=a.dialog(e),e.id||(e.close=e.close||function(){t.dialog("destroy"),t.remove(),$(t.resizeEvent).off()});var o;return t.resizeEvent=$(window).on("resize",function(){clearTimeout(o),o=setTimeout(function(){n.resize(t)},100)}),t}},nb.dialog.Filter=function(e,t,n,a){function o(){if(0===$(".dialog-filter input[data-role=search]",h).length){r=$(f,p[0]);var e=$(".toggle-response",p[0]).length>0;r.length<s&&!e||(0===$(".dialog-filter",h).length&&p.before("<div class=dialog-filter></div>"),$(".dialog-filter",h).append('<input type=text name=keyword data-role=search placeholder="'+nb.getText("filter","Фильтр")+'" />'),l=$(".dialog-filter input[data-role=search]",h),l.on("keyup",function(e){try{if(clearTimeout(u),13===e.keyCode)return}catch(t){console.log(t)}u=setTimeout(function(){r=$(f,p[0]),i(e.target.value)},c)}))}}function i(e){try{if(e.length>=d){var t=0,n=new RegExp(e,"gim");r.attr("style",""),r.each(function(a,o){n.test(o.textContent)||-1!=o.textContent.indexOf(e)||0===$(":checked",o).length&&(o.style.display="none",t++)}),r.length>t?l.attr("title","By keyword ["+e+"] filtered "+(r.length-t)):l.attr("title",nb.getText("filter_no_results","Не найдено"))}else r.attr("style",""),l.attr("title","")}catch(a){console.log(a)}}var r,l=null,s=n||13,d=a||2,c=300,u=null,f=t||".item",p=e,h=p.parents("[role=dialog]");o()},nb.windowOpen=function(e,t,n){var a,o=800,i=600,r=(window.innerHeight-i)/2,l=(window.innerWidth-o)/2;0>r&&(r=0),0>l&&(l=0),a="top="+r+",left="+l,a+=",height="+i+",width="+o+",resizable=yes,scrollbars=yes,status=no";var s="window-"+(t||e.hashCode()),d=window.open("",s,a);if(("about:blank"===d.document.URL||""===d.document.URL)&&(d=window.open(e,s,a),n&&n.onclose))var c=setInterval(function(){d.closed&&(clearInterval(c),n.onclose())},1e3);d.focus()},nb.submitForm=function(e){if(!nb.validateForm(e)){var t=$.Deferred();return t.reject(!1)}var n=nb.notify({message:nb.getText("wait_while_document_save","Пожалуйста ждите... идет сохранение документа"),type:"process"}).show(),a={cache:!1,type:"POST",dataType:"json",url:"Provider",data:$(e).serialize(),beforeSend:function(){nb.uiBlock(),$(".required, .has-error",e).removeClass("required has-error"),$(".error-massage",e).remove()},success:function(e){return n.set({text:e.captions.type,type:"success"}),e.redirectURL&&(window.location.href=e.redirectURL),e},error:function(t){var a=t.responseJSON,o={type:"error"};return"VALIDATION_ERROR"===a.type?(o.text=a.captions.type,nb.validateForm(e,a.validation)):"SERVER_ERROR"===a.type&&(o.text=a.captions.type),n.set(o),t},complete:function(){nb.uiUnblock(),n.remove(2e3)}};return nb.ajax(a)},nb.validateForm=function(e,t){var n=!0;if(t&&t.errors){var a=t.errors;for(var o in a){0==o&&$("[name="+a[o].field+"]").focus(),$("[name="+a[o].field+"]",e).attr("required","required").addClass("required");var i=$("[data-input="+a[o].field+"]",e).addClass("required"),r=$("<div class=error-massage>"+a[o].message+"</div>");i.length?(i.after(r),i.parent().addClass("has-error")):($("[name="+a[o].field+"]",e).after(r),$("[name="+a[o].field+"]",e).parent().addClass("has-error"))}}return $("[required]:invalid",e).length&&($("[required]:invalid",e).first().focus(),n=!1),n},nb.setFormValues=function(e){function t(){var e=l.length>1,t={};return l.each(function(){var a,o,l,s,d,c,u=this.value;for(a in r){if(o=r[a],l=$("[data-id="+u+"][name="+a+"]",n),s=$("[name="+o+"]",i),d=l.val(),c=l.data("text"),c||(c=d),e)t[a]!==!0&&s.remove(),s=$('<input type="hidden" name="'+o+'" />'),s.appendTo(i);else{var f=$("[type=hidden][name="+o+"]",i);f.length&&(f.remove(),s=$('<input type="hidden" name="'+o+'" />'),s.appendTo(i))}0===s.length&&(s=$('<input type="hidden" name="'+o+'" />'),s.appendTo(i)),s.val(d),e?t[a]!==!0?(t[a]=!0,$("[data-input="+o.replace("id","")+"]",i).html("<li>"+c+"</li>")):$("[data-input="+o.replace("id","")+"]",i).append("<li>"+c+"</li>"):$("[data-input="+o.replace("id","")+"]",i).html(c)}}),!0}var n=$(e).parents("[role=dialog]"),a=$("[data-role=nb-dialog]",n),o=a[0].dialogOptions,i=nb.getForm(o.targetForm),r=o.fields;if(!i)return nb.dialog.warn({title:"Error",message:"Error nb.setFormValues > form is not found: "+i}),!1;var l=$("[data-type=select]:checked",n);return l.length?t():(o.effect&&(n.stop(),n.effect(o.effect,{times:2},300)),0===$(".no-selected-value",n[0]).length&&!function(){var e=$("<div class=no-selected-value>"+o.errorMessage+"</div>");a.after(e),setTimeout(function(){e.fadeOut({always:function(){e.remove()}})},500)}(),!1)},nb.clearFormFields=function(e,t){var n=nb.getForm(t);for(var a in e)$("[name="+e[a]+"]",n).val(""),$("[data-input="+e[a]+"]",n).html("")},nb.notify=function(e){var t=$("#nb-notify-wrapper");t.length||(t=$("<div id=nb-notify-wrapper class=nb-notify></div>").appendTo("body"));var n=$("<div class=nb-notify-entry-"+(e.type||"info")+">"+e.message+"</div>").appendTo(t);return{show:function(e,t){return n.css("display","block"),e&&e>0?void this.remove(e,t):this},hide:function(){return n.css("display","none"),this},set:function(e){for(var t in e)"text"===t?n.text(e[t]):"type"===t&&n.attr("class","nb-notify-entry-"+e[t]);return this},remove:function(e,t){if(null!==n)if(e&&e>0){setTimeout(function(){n.remove(),n=null,t&&t()},e)}else n.remove(),n=null,t&&t()}}},nb.xhrDelete=function(e){return $.ajax({type:"DELETE",dataType:"json",url:location.href+"&"+e})},nb.tpl={},nb.tpl.defaultDialogListTemplate=function(e){var t=e.objects[0];if(!t.length)return"empty list";var n,a,o=this.id,i=[];i.push("<ul class=nb-dialog-list>");for(a in t)n=t[a],i.push("<li class=nb-dialog-list-it>"),i.push(' <label ondblclick="nb.dialog.execute(this)">'),i.push('  <input data-type="select" type="radio" name="select_'+o+'" value="'+n.id+'"/>'),i.push("  <span>"+n.name+"</span>"),i.push('  <input data-id="'+n.id+'" name="id" value="'+n.id+'" data-text="'+n.name+'" type="hidden"/>'),i.push(" </label>"),i.push("</li>");return i.push("</ul>"),i.join("")},nb.getSelectedEntityIDs=function(e){var t=$("input[name="+(e||"docid")+"]:checked");if(0===t.length)return[];var n=[];return t.each(function(){n.push(this.value)}),n},nb.setSearchReferToSessionStorage=function(){-1==location.href.indexOf("id=search")&&sessionStorage.setItem("search_refer",location.href)},nb.resetSearchFromRefer=function(){var e=sessionStorage.getItem("search_refer");e?location.href=e:history.back()},$(document).ready(function(){$("form[name=ft-search]").on("submit",function(){return nb.setSearchReferToSessionStorage(),!0}),$("[data-action=reset_search]").click(function(e){e.preventDefault(),nb.resetSearchFromRefer()})}),nbApp.defaultChoiceDialog=function(e,t,n,a){var o=nb.getForm(e),i=nb.dialog.show({targetForm:o.name,fields:n,title:e.title,href:"Provider?id="+t,dataType:"html",buttons:{ok:{text:nb.getText("select"),click:function(){i[0].dialogOptions.onExecute(),a&&a()}},cancel:{text:nb.getText("cancel"),click:function(){i.dialog("close")}}}});return i},nbApp.choiceBalanceHolder=function(e,t){var n=nb.getForm(e);return this.defaultChoiceDialog(e,"get-organizations&_fn="+n.name,{docid:"balanceholder",bin:"balanceholderbin"},t)},nbApp.choiceReaders=function(e,t){var n=nb.getForm(e);return this.defaultChoiceDialog(e,"get-employees&_fn="+n.name,{docid:"reader"},t)},$(document).ready(function(){initCachedUpdateForm()});