"use strict";var nb={APP_NAME:location.hostname,LANG_ID:"RUS",debug:!0,translations:{yes:"Да",no:"Нет",ok:"Ok",cancel:"Отмена",select:"Выбрать",dialog_select_value:"Вы не сделали выбор"},dialog:{},xhr:{}},nbApp={};nb.ajax=function(e){return $.ajax(e)},nb.getText=function(e,t){return this.translations[e]?this.translations[e]:void 0!==t?t:e},nb.getForm=function(e){if(null===e||void 0===e)return e;if("string"==typeof e&&document[e]&&"FORM"===document[e].nodeName)return document[e];var t=$(e).parents("form");return t.length&&(e=t.get(0)),e.form||e},nb.uiBlock=function(){var e=$("#nb-block-ui");0===e.length&&(e=$('<div id="nb-block-ui" style="background:rgba(0,0,0,0.1);cursor:wait;position:fixed;top:0;left:0;bottom:0;right:0;z-index:999;"/>'),e.appendTo("body")),e.css("display","block")},nb.uiUnblock=function(){$("#nb-block-ui").css("display","none")},$(document).ready(function(){nb.LANG_ID=$.cookie("lang")||"RUS";var e=localStorage.getItem("side-tree-toggle"),t=[];null!=e?t=e.split(","):localStorage.setItem("side-tree-toggle",""),$("[data-nav]",".aside").each(function(){-1!=t.indexOf($(this).data("nav"))&&$(this).removeClass("nav-link-collapsed")}),$(":checkbox").bind("click",function(){var e=$(this);if(!e.data("toggle"))return!0;var t=this.name||e.data("toggle"),n=$("[name="+t+"]:checkbox:visible");e.is(":checked")?n.each(function(){this.checked=!0}):n.each(function(){this.checked=!1})}),$("[data-role=side-tree-toggle]").click(function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();t.toggleClass("nav-link-collapsed");var n="side-tree-toggle",o=t.data("nav"),i=localStorage.getItem(n),a=i.split(",");if(t.hasClass("nav-link-collapsed")){var l=a.indexOf(o);l>-1&&a.splice(l,1),localStorage.setItem(n,a.join(","))}else a.push(o),localStorage.setItem(n,a.join(","))}),$(document).on("click","[data-toggle=panel]",function(){var e=$(this).parents(".panel");e.toggleClass("open")}),$(document).on("click","[data-toggle=side-nav]",function(e){e.preventDefault(),$("body").toggleClass("side-nav-toggle")}),$("#content-overlay").length&&($("#content-overlay").mousedown(function(e){e.preventDefault(),$("body").removeClass("side-nav-toggle")}),$("#content-overlay")[0].addEventListener("touchstart",function(e){e.preventDefault(),$("body").removeClass("side-nav-toggle")},!1)),$(window).resize(function(){window.innerWidth<=800?$("body").addClass("phone"):$("body").removeClass("phone")}),window.innerWidth<=800&&$("body").addClass("phone"),setTimeout(function(){$("body").removeClass("no_transition")},250)}),nb.dialog={_props:{title:nb.APP_NAME},info:function(e){return e.className="dialog-info",e.width=e.width||"360",e.height=e.height||"210",e.buttons=e.buttons||{Ok:function(){$(this).dialog("close")}},this.show(e)},warn:function(e){return e.className="dialog-warn",e.width=e.width||"360",e.height=e.height||"210",e.buttons=e.buttons||{Ok:function(){$(this).dialog("close")}},this.show(e)},error:function(e){return e.className="dialog-error",e.width=e.width||"360",e.height=e.height||"210",e.buttons=e.buttons||{Ok:function(){$(this).dialog("close")}},this.show(e)},execute:function(e){var t=$(e).parents("[role=dialog]"),n=$("[data-role=nb-dialog]",t);n[0].dialogOptions.onExecute(arguments)},load:function(e,t,n){return $.ajax({url:e,success:function(e,o,i){if("error"===o)t.html('<div class="alert alert-danger">'+o+"</div>"),nb.debug===!0&&console.log("nb.dialog : load callback",i);else{t.html(e);try{null!==n.onLoad&&n.onLoad(e,o,i)}catch(a){console.log("nb.dialog",a)}try{n.filter!==!1&&new nb.dialog.Filter(t,n.dialogFilterListItem,13)}catch(a){console.log("nb.dialog",a)}}},error:function(e,n,o){"error"===n&&(t.html('<div class="alert alert-danger">'+n+"</div>"),nb.debug===!0&&console.log("nb.dialog : load callback",o))}})},show:function(e){var t;if(e.id=e.id||null,e.title=e.title||this._props.title,e.href=e.href||null,e.className=e.className||"",e.message=e.message||null,e.filter=e.filter,e.dialogFilterListItem=e.dialogFilterListItem||"li",e.buttons=e.buttons||null,e.dialogClass="nb-dialog "+(e.dialogClass?e.dialogClass:""),e.errorMessage=e.errorMessage||nb.getText("dialog_select_value"),e.onLoad=e.onLoad||null,e.onExecute=e.onExecute||function(){nb.setFormValues(t)&&t.dialog("close")},e.autoOpen=!0,e.modal===!1?e.modal=!1:e.modal=!0,e.width=e.width||"360",e.position=e.position||"center",e.resizable=e.resizable||!1,e.draggable=e.draggable||!1,null===e.id&&e.href){if(e.id="dlg_"+e.href.replace(/[^a-z0-9]/gi,""),t=$("#"+e.id),t[0])return t.dialog("isOpen")===!0?void 0:void t.dialog("open")}else if(null!==e.id&&(t=$("#"+e.id),t[0]))return t.dialog("isOpen")===!0?void 0:void t.dialog("open");null===e.id&&(e.close=e.close||function(){t.dialog("destroy"),t.remove()});var n;n=e.href?$('<div data-role="nb-dialog" id="'+e.id+'" class="nb-dialog-container '+e.className+'"><div class="loading-state"></div></div>'):e.id?$('<div data-role="nb-dialog" id="'+e.id+'" class="nb-dialog-container '+e.className+'">'+e.message+"</div>"):$('<div data-role="nb-dialog" class="nb-dialog-container '+e.className+'">'+e.message+"</div>");var o=this;return e.href?(o.load(e.href,n,e),t=n.dialog(e),t.on("click","a",function(t){t.preventDefault(),o.load(this.href,n,e)}),t.on("change","select",function(t){t.preventDefault(),o.load(this.href,n,e)})):t=n.dialog(e),t[0].dialogOptions=e,nb.debug===!0&&console.log("nb.dialog: ",e),t}},nb.dialog.Filter=function(e,t,n,o){function i(){if(0===$(".dialog-filter input[data-role=search",f).length){l=$(g,h[0]);var e=$(".toggle-response",h[0]).length>0;l.length<s&&!e||(0===$(".dialog-filter",f).length&&h.before("<div class=dialog-filter></div>"),$(".dialog-filter",f).append('<input type=text name=keyword data-role=search placeholder="'+nb.getText("filter","Фильтр")+'" />'),r=$(".dialog-filter input[data-role=search]",f),r.on("keyup",function(e){try{if(clearTimeout(u),13===e.keyCode)return}catch(t){console.log(t)}u=setTimeout(function(){l=$(g,h[0]),a(e.target.value)},c)}))}}function a(e){try{if(e.length>=d){var t=0,n=new RegExp(e,"gim");l.attr("style",""),l.each(function(o,i){n.test(i.textContent)||-1!=i.textContent.indexOf(e)||0===$(":checked",i).length&&(i.style.display="none",t++)}),l.length>t?r.attr("title","By keyword ["+e+"] filtered "+(l.length-t)):r.attr("title",nb.getText("filter_no_results","Не найдено"))}else l.attr("style",""),r.attr("title","")}catch(o){console.log(o)}}var l,r=null,s=n||13,d=o||2,c=300,u=null,g=t||".item",h=e,f=h.parents("[role=dialog]");i()},nb.windowOpen=function(e,t,n){var o,i=800,a=600,l=(window.innerHeight-a)/2,r=(window.innerWidth-i)/2;0>l&&(l=0),0>r&&(r=0),o="top="+l+",left="+r,o+=",height="+a+",width="+i+",resizable=yes,scrollbars=yes,status=no";var s="window-"+(t||e.hashCode()),d=window.open("",s,o);if(("about:blank"===d.document.URL||""===d.document.URL)&&(d=window.open(e,s,o),n&&n.onclose))var c=setInterval(function(){d.closed&&(clearInterval(c),n.onclose())},1e3);d.focus()},nb.submitForm=function(e){if(!nb.validateForm(e)){var t=$.Deferred();return t.reject(!1)}var n=nb.notify({message:nb.getText("wait_while_document_save","Пожалуйста ждите... идет сохранение документа"),type:"process"}).show(),o={cache:!1,type:"POST",dataType:"json",url:"Provider",data:$(e).serialize(),beforeSend:function(){nb.uiBlock(),$(".required, .has-error",e).removeClass("required has-error"),$(".error-massage",e).remove()},success:function(e){return n.set({text:e.captions.type,type:"success"}),e.redirectURL&&(window.location.href=e.redirectURL),e},error:function(t){var o=t.responseJSON,i={type:"error"};return"VALIDATION_ERROR"===o.type?(i.text=o.captions.type,nb.validateForm(e,o.validation)):"SERVER_ERROR"===o.type&&(i.text=o.captions.type),n.set(i),t},complete:function(){nb.uiUnblock(),n.remove(2e3)}};return nb.ajax(o)},nb.validateForm=function(e,t){var n=!0;if(t&&t.errors){var o=t.errors;for(var i in o){0==i&&$("[name="+o[i].field+"]").focus(),$("[name="+o[i].field+"]",e).attr("required","required").addClass("required");var a=$("[data-input="+o[i].field+"]",e).addClass("required"),l=$("<div class=error-massage>"+o[i].message+"</div>");a.length?(a.after(l),a.parent().addClass("has-error")):($("[name="+o[i].field+"]",e).after(l),$("[name="+o[i].field+"]",e).parent().addClass("has-error"))}}return $("[required]:invalid",e).length&&($("[required]:invalid",e).first().focus(),n=!1),n},nb.setFormValues=function(e){function t(){var e=l.length>1,t={};return l.each(function(){var o,l,r,s,d,c,u=this.value;for(o in a){if(l=a[o],r=$("[data-id="+u+"][name="+o+"]",n),s=$("[name="+l+"]",i),d=r.val(),c=r.data("text"),c||(c=d),e)t[o]!==!0&&s.remove(),s=$('<input type="hidden" name="'+l+'" />'),s.appendTo(i);else{var g=$("[type=hidden][name="+l+"]",i);g.length&&(g.remove(),s=$('<input type="hidden" name="'+l+'" />'),s.appendTo(i))}0===s.length&&(s=$('<input type="hidden" name="'+l+'" />'),s.appendTo(i)),s.val(d),e?t[o]!==!0?(t[o]=!0,$("[data-input="+l.replace("id","")+"]",i).html("<li>"+c+"</li>")):$("[data-input="+l.replace("id","")+"]",i).append("<li>"+c+"</li>"):$("[data-input="+l.replace("id","")+"]",i).html(c)}}),!0}var n=$(e).parents("[role=dialog]"),o=$("[data-role=nb-dialog]",n),i=nb.getForm(o[0].dialogOptions.targetForm),a=o[0].dialogOptions.fields;if(!i)return nb.dialog.warn({title:"Error",message:"Error nb.setFormValues > form is not found: "+i}),!1;var l=$("[data-type=select]:checked",o[0]);return l.length?t():(o[0].dialogOptions.effect&&(n.stop(),n.effect(o[0].dialogOptions.effect,{times:2},300)),0===$(".js-no-selected-value",n[0]).length&&!function(){var e=$('<div class="alert alert-danger js-no-selected-value" style="border-radius:2px;bottom:80px;left:4%;right:4%;position:absolute;">'+o[0].dialogOptions.errorMessage+"</div>");o.after(e),setTimeout(function(){e.fadeOut({always:function(){e.remove()}})},800)}(),!1)},nb.clearFormFields=function(e,t){var n=nb.getForm(t);for(var o in e)$("[name="+e[o]+"]",n).val(""),$("[data-input="+e[o]+"]",n).html("")},nb.notify=function(e){var t=$("#nb-notify-wrapper");t.length||(t=$("<div id=nb-notify-wrapper class=nb-notify></div>").appendTo("body"));var n=$("<div class=nb-notify-entry-"+(e.type||"info")+">"+e.message+"</div>").appendTo(t);return{show:function(e){return n.css("display","block"),e&&e>0?void this.remove(e):this},hide:function(){return n.css("display","none"),this},set:function(e){for(var t in e)"text"===t?n.text(e[t]):"type"===t&&n.attr("class","nb-notify-entry-"+e[t]);return this},remove:function(e,t){if(null!==n)if(e&&e>0){setTimeout(function(){n.remove(),n=null,t&&t()},e)}else n.remove(),n=null,t&&t()}}},nb.xhr.doDelete=function(e){return $.ajax({type:"DELETE",dataType:"json",url:location.href+"&"+e})},nb.getSelectedEntityIDs=function(e){var t=$("input[name="+(e||"docid")+"]:checked");if(0===t.length)return[];var n=[];return t.each(function(){n.push(this.value)}),n},nbApp.defaultChoiceDialog=function(e,t,n){var o=nb.getForm(e),i=nb.dialog.show({targetForm:o.name,fields:n,title:e.title,href:"Provider?id="+t,buttons:{ok:{text:nb.getText("select"),click:function(){i[0].dialogOptions.onExecute()}},cancel:{text:nb.getText("cancel"),click:function(){i.dialog("close")}}}});return i},nbApp.choiceBalanceHolder=function(e){return this.defaultChoiceDialog(e,"get-organizations",{docid:"balanceholderid",bin:"balanceholderbin"})},nbApp.choiceCountries=function(e){return this.defaultChoiceDialog(e,"get-countries","country")},nbApp.choiceRegion=function(e){return this.defaultChoiceDialog(e,"get-regions","region")},nbApp.choiceDistrict=function(e){return this.defaultChoiceDialog(e,"get-district","district")},nbApp.choiceCity=function(e){return this.defaultChoiceDialog(e,"get-city","city")},nbApp.choiceStreet=function(e){return this.defaultChoiceDialog(e,"get-street","street")},$(function(){var e=$("form[role=search]");e.length&&e[0].reset(),$("[data-action=save_and_close]").click(function(e){e.preventDefault(),nb.submitForm(nb.getForm(this))}),$("[data-action=delete_document]").click(function(e){e.preventDefault();var t=nb.getSelectedEntityIDs("docid");t.length&&nb.xhr.doDelete("docid="+t.join("&docid=")).then(function(){location.reload()})}),$("[data-action=delete_document]").attr("disabled",!0),$(":checkbox").bind("change",function(){var e=$("[name=docid]:checked").length;$("[data-action=delete_document]").attr("disabled",0===e)}),$("[name=docid]:checked").attr("checked",!1),$("[data-toggle-theme]").click(function(){var e=$(this).data("toggle-theme");$("body").hasClass("theme1")?($("body").removeClass(e),localStorage.setItem("theme","")):($("body").addClass(e),localStorage.setItem("theme",e))});var t=localStorage.getItem("theme");t&&$("body").addClass(t)});